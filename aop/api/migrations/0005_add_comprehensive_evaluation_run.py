# Generated by Django 5.2.3 on 2025-12-05 07:27

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0004_eventwal_replaysnapshot_replayrun_cachedtoolresponse_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='EvaluationRun',
            fields=[
                ('run_id', models.UUIDField(db_index=True, default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('initiated_by', models.CharField(help_text='User ID, system, CI/CD webhook, or API client', max_length=255)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('started_at', models.DateTimeField(blank=True, db_index=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('queued', 'Queued'), ('running', 'Running'), ('completed', 'Completed'), ('failed', 'Failed'), ('cancelled', 'Cancelled'), ('timeout', 'Timeout')], db_index=True, default='pending', max_length=20)),
                ('scenario_set', models.JSONField(default=list, help_text='List of scenario IDs (business, adversarial, domain-specific)')),
                ('run_mode', models.CharField(choices=[('single_turn', 'Single Turn'), ('multi_turn', 'Multi Turn'), ('streaming', 'Streaming'), ('batch', 'Batch')], default='single_turn', max_length=20)),
                ('max_steps', models.IntegerField(default=100, help_text='Max number of agent actions before forced stop')),
                ('timeout_seconds', models.IntegerField(default=300, help_text='Total run timeout in seconds')),
                ('parallelism', models.IntegerField(default=1, help_text='How many scenario simulations run concurrently')),
                ('seed', models.BigIntegerField(blank=True, help_text='Global seed for orchestrator RNG', null=True)),
                ('agent_seed', models.BigIntegerField(blank=True, help_text='Seed to pass to LLM sampling layer', null=True)),
                ('fixed_sampling', models.BooleanField(default=False, help_text='If true: temp=0, seed enforced')),
                ('capture_model_outputs', models.BooleanField(default=True, help_text='Store LLM outputs for deterministic replay')),
                ('environment_snapshot_id', models.CharField(blank=True, help_text='State snapshot of mock systems', max_length=255)),
                ('snapshot_restore_mode', models.CharField(default='full', help_text='full, partial, or none', max_length=20)),
                ('enable_pii_detection', models.BooleanField(default=True)),
                ('enable_policy_enforcement', models.BooleanField(default=True)),
                ('enable_bias_check', models.BooleanField(default=False)),
                ('enable_hallucination_check', models.BooleanField(default=True)),
                ('enable_prompt_injection_detection', models.BooleanField(default=True)),
                ('enable_action_boundary_check', models.BooleanField(default=True)),
                ('enable_privacy_leak_detection', models.BooleanField(default=True)),
                ('enable_sensitive_topic_detection', models.BooleanField(default=False)),
                ('max_pii_leak_tolerance', models.IntegerField(default=0, help_text='Allowed count before run marked fail')),
                ('max_policy_violation_tolerance', models.IntegerField(default=0)),
                ('max_hallucination_threshold', models.FloatField(default=0.1, help_text='Max hallucination rate (0.0-1.0)')),
                ('max_output_variance_threshold', models.FloatField(default=0.2, help_text='OVS â€” consistency metric')),
                ('redteam_enabled', models.BooleanField(default=False)),
                ('redteam_level', models.CharField(choices=[('none', 'None'), ('low', 'Low - Basic jailbreaks'), ('medium', 'Medium - Multi-turn attacks'), ('high', 'High - Drift + chain attacks'), ('extreme', 'Extreme - Paraphrase-bedlam stress')], default='none', max_length=20)),
                ('attack_modules_enabled', models.JSONField(default=list, help_text='e.g., ["prompt_injection", "context_drift", "multi_turn_override"]')),
                ('max_redteam_events', models.IntegerField(default=100, help_text='Max adversarial events to inject')),
                ('custom_attack_payloads', models.JSONField(blank=True, default=list, help_text='Optional list of custom attack payloads')),
                ('input_variables', models.JSONField(default=dict, help_text='Dynamic scenario inputs (personas, budgets, order IDs, synthetic PII)')),
                ('actor_profiles', models.JSONField(default=dict, help_text='User types: angry customer, confused employee, technical auditor')),
                ('file_upload_variants', models.JSONField(blank=True, default=list, help_text='List of files / fuzzing modes')),
                ('agent_endpoint_url', models.URLField(blank=True, help_text='Agent API endpoint', max_length=500)),
                ('agent_model_name', models.CharField(blank=True, help_text='e.g., gpt-4, claude-3-opus', max_length=100)),
                ('agent_temperature', models.FloatField(blank=True, help_text='LLM temperature (0.0-2.0)', null=True)),
                ('agent_top_p', models.FloatField(blank=True, help_text='LLM top_p sampling', null=True)),
                ('agent_tool_permissions', models.JSONField(default=list, help_text='List of allowed tools')),
                ('max_tool_calls_allowed', models.IntegerField(default=50, help_text='Max tool calls per run')),
                ('final_output_format', models.CharField(default='toon', help_text='text / structured / JSON / Toon', max_length=20)),
                ('reasoning_log_required', models.BooleanField(default=True)),
                ('allow_recursive_reasoning', models.BooleanField(default=False)),
                ('trace_level', models.CharField(choices=[('none', 'None'), ('minimal', 'Minimal'), ('full', 'Full'), ('full_reasoning', 'Full + Reasoning')], default='full', max_length=20)),
                ('store_reasoning_logs', models.BooleanField(default=True)),
                ('store_intermediate_actions', models.BooleanField(default=True)),
                ('store_environment_state_deltas', models.BooleanField(default=False)),
                ('retain_traces_for_days', models.IntegerField(default=90, help_text='Trace retention period')),
                ('enable_pii_redaction', models.BooleanField(default=True, help_text='Redact PII in stored traces')),
                ('min_safety_grade_required', models.FloatField(default=0.9, help_text='Minimum ASG score (0.0-1.0)')),
                ('max_allowed_policy_violations', models.IntegerField(default=0)),
                ('max_hallucination_rate', models.FloatField(default=0.05)),
                ('max_action_misuse', models.IntegerField(default=0)),
                ('min_redteam_survival_rate', models.FloatField(default=0.95, help_text='Min % of redteam attacks survived')),
                ('min_output_consistency', models.FloatField(default=0.9, help_text='Min consistency score')),
                ('min_reproducibility_score', models.FloatField(default=0.95, help_text='Min determinism score')),
                ('report_format', models.CharField(choices=[('json', 'JSON'), ('pdf', 'PDF'), ('html', 'HTML'), ('toon', 'Toon')], default='json', max_length=10)),
                ('include_recommendations', models.BooleanField(default=True)),
                ('include_evidence_pack', models.BooleanField(default=True)),
                ('include_raw_traces', models.BooleanField(default=False)),
                ('suppress_sensitive_fields_in_report', models.BooleanField(default=True)),
                ('trigger_source', models.CharField(choices=[('human', 'Human'), ('cicd', 'CI/CD Pipeline'), ('auto_monitor', 'Auto Monitor'), ('webhook', 'Webhook'), ('api', 'API')], default='human', max_length=20)),
                ('deployment_target', models.CharField(choices=[('dev', 'Development'), ('staging', 'Staging'), ('canary', 'Canary'), ('pre_prod', 'Pre-Production'), ('prod', 'Production')], default='dev', max_length=20)),
                ('block_deployment_on_failure', models.BooleanField(default=False, help_text='Gate deployment if evaluation fails')),
                ('notify_channels', models.JSONField(default=list, help_text='Slack/Teams/webhook URLs')),
                ('credits_used', models.DecimalField(decimal_places=2, default=0.0, max_digits=10)),
                ('time_estimated_seconds', models.IntegerField(blank=True, null=True)),
                ('compute_units_consumed', models.FloatField(default=0.0)),
                ('run_priority', models.CharField(choices=[('low', 'Low'), ('medium', 'Medium'), ('high', 'High'), ('critical', 'Critical')], default='medium', max_length=20)),
                ('results', models.JSONField(blank=True, default=dict, help_text='Evaluation results including scores, violations, metrics')),
                ('error_message', models.TextField(blank=True)),
                ('evaluator_version', models.CharField(default='1.0.0', max_length=50)),
                ('agent', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='evaluation_runs', to='api.agent')),
                ('associated_run', models.ForeignKey(blank=True, help_text='Associated agent run being evaluated (optional)', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='evaluation_runs', to='api.run')),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='evaluation_runs', to='api.organization')),
            ],
            options={
                'verbose_name': 'Evaluation Run',
                'verbose_name_plural': 'Evaluation Runs',
                'db_table': 'api_evaluation_run',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['organization', 'status'], name='api_evaluat_organiz_00732b_idx'), models.Index(fields=['agent', 'status'], name='api_evaluat_agent_i_e52cb8_idx'), models.Index(fields=['created_at'], name='api_evaluat_created_e3661d_idx'), models.Index(fields=['started_at'], name='api_evaluat_started_127432_idx'), models.Index(fields=['trigger_source', 'status'], name='api_evaluat_trigger_413ede_idx'), models.Index(fields=['deployment_target'], name='api_evaluat_deploym_45c09d_idx')],
            },
        ),
    ]
