# Generated by Django 5.2.3 on 2025-12-05 05:04

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0003_alter_organization_salt_key_agentapikey_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='EventWAL',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('run_id', models.UUIDField(db_index=True)),
                ('agent_id', models.IntegerField(db_index=True)),
                ('seq_no', models.IntegerField()),
                ('idempotency_key', models.CharField(db_index=True, max_length=255, unique=True)),
                ('event_type', models.CharField(max_length=50)),
                ('timestamp', models.DateTimeField()),
                ('payload', models.JSONField()),
                ('metadata', models.JSONField(blank=True, default=dict)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('processing', 'Processing'), ('completed', 'Completed'), ('failed', 'Failed'), ('retrying', 'Retrying')], db_index=True, default='pending', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('processed_at', models.DateTimeField(blank=True, null=True)),
                ('error_message', models.TextField(blank=True)),
                ('retry_count', models.IntegerField(default=0)),
                ('last_retry_at', models.DateTimeField(blank=True, null=True)),
                ('signature', models.CharField(max_length=64)),
                ('signature_verified', models.BooleanField(default=False)),
            ],
            options={
                'db_table': 'api_event_wal',
                'ordering': ['run_id', 'seq_no'],
                'indexes': [models.Index(fields=['status', 'created_at'], name='api_event_w_status_6098ec_idx'), models.Index(fields=['run_id', 'seq_no'], name='api_event_w_run_id_c77046_idx'), models.Index(fields=['agent_id', 'created_at'], name='api_event_w_agent_i_25003a_idx')],
                'unique_together': {('run_id', 'seq_no')},
            },
        ),
        migrations.CreateModel(
            name='ReplaySnapshot',
            fields=[
                ('snapshot_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('seed', models.IntegerField(help_text='Random seed for reproducibility')),
                ('model_name', models.CharField(help_text='LLM model identifier', max_length=255)),
                ('temperature', models.FloatField(default=0.7, help_text='Sampling temperature')),
                ('top_p', models.FloatField(default=0.9, help_text='Nucleus sampling threshold')),
                ('max_tokens', models.IntegerField(blank=True, help_text='Max generation tokens', null=True)),
                ('other_params', models.JSONField(default=dict, help_text='Other model params (top_k, frequency_penalty, etc.)')),
                ('environment_snapshot_id', models.UUIDField(blank=True, help_text='Reference to EnvironmentSnapshot for system state', null=True)),
                ('db_snapshot_id', models.CharField(blank=True, help_text='Database snapshot identifier (for mock DB state)', max_length=255, null=True)),
                ('db_snapshot_url', models.URLField(blank=True, help_text='URL to database snapshot storage', max_length=1024, null=True)),
                ('tool_responses_cached', models.BooleanField(default=False, help_text='Whether tool responses are cached for replay')),
                ('llm_responses_cached', models.BooleanField(default=False, help_text='Whether LLM responses are cached (requires permission)')),
                ('is_replayable', models.BooleanField(default=True, help_text='Whether this run can be replayed')),
                ('replay_mode', models.CharField(choices=[('full', 'Full replay with cached responses'), ('hybrid', 'Hybrid: cached tools, re-run model'), ('verification', 'Verification only: re-run and compare')], default='full', max_length=50)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('metadata', models.JSONField(default=dict, help_text='Additional replay context')),
                ('run', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='replay_snapshot', to='api.run')),
            ],
            options={
                'db_table': 'replay_snapshots',
            },
        ),
        migrations.CreateModel(
            name='ReplayRun',
            fields=[
                ('replay_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('replay_mode', models.CharField(choices=[('full', 'Full replay with cached responses'), ('hybrid', 'Hybrid: cached tools, re-run model'), ('verification', 'Verification: re-run and compare')], default='full', max_length=50)),
                ('use_cached_llm', models.BooleanField(default=True, help_text='Use cached LLM responses')),
                ('use_cached_tools', models.BooleanField(default=True, help_text='Use cached tool responses')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('completed', 'Completed'), ('failed', 'Failed')], default='pending', max_length=50)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('total_events', models.IntegerField(default=0)),
                ('matching_events', models.IntegerField(default=0)),
                ('divergent_events', models.IntegerField(default=0)),
                ('reproducibility_score', models.FloatField(default=0.0, help_text='Percentage of matching events (0.0-1.0)')),
                ('comparison_report', models.JSONField(default=dict, help_text='Detailed comparison results')),
                ('divergences', models.JSONField(default=list, help_text='List of specific divergences found')),
                ('error_message', models.TextField(blank=True, null=True)),
                ('original_run', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='replays', to='api.run')),
                ('replayed_run', models.ForeignKey(blank=True, help_text='New run created during replay', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='replay_of', to='api.run')),
                ('snapshot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='replay_runs', to='api.replaysnapshot')),
            ],
            options={
                'db_table': 'replay_runs',
            },
        ),
        migrations.CreateModel(
            name='CachedToolResponse',
            fields=[
                ('cache_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('seq_no', models.IntegerField(help_text='Sequence number of action_response event')),
                ('action_name', models.CharField(help_text='Name of the action/tool', max_length=255)),
                ('params_hash', models.CharField(db_index=True, help_text='SHA-256 hash of parameters for cache lookup', max_length=64)),
                ('params', models.JSONField(help_text='Original parameters')),
                ('status', models.CharField(choices=[('success', 'Success'), ('error', 'Error')], default='success', max_length=50)),
                ('result', models.JSONField(help_text='Tool response result')),
                ('error', models.TextField(blank=True, help_text='Error message if failed', null=True)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('latency_ms', models.IntegerField(help_text='Original tool latency')),
                ('snapshot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='cached_tool_responses', to='api.replaysnapshot')),
            ],
            options={
                'db_table': 'cached_tool_responses',
            },
        ),
        migrations.CreateModel(
            name='CachedLLMResponse',
            fields=[
                ('cache_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('seq_no', models.IntegerField(help_text='Sequence number of the event')),
                ('event_type', models.CharField(help_text='Type of event (reasoning, action_request, etc.)', max_length=50)),
                ('prompt_hash', models.CharField(db_index=True, help_text='SHA-256 hash of the prompt for cache lookup', max_length=64)),
                ('model_name', models.CharField(max_length=255)),
                ('response_text', models.TextField(help_text='Raw LLM response')),
                ('response_tokens', models.IntegerField(help_text='Token count')),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('latency_ms', models.IntegerField(help_text='Original response latency')),
                ('finish_reason', models.CharField(blank=True, help_text='Why generation stopped (length, stop, etc.)', max_length=50, null=True)),
                ('consent_given', models.BooleanField(default=False, help_text='User consented to caching')),
                ('expires_at', models.DateTimeField(blank=True, help_text='When this cached response should be deleted', null=True)),
                ('snapshot', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='cached_responses', to='api.replaysnapshot')),
            ],
            options={
                'db_table': 'cached_llm_responses',
            },
        ),
        migrations.CreateModel(
            name='RetentionPolicy',
            fields=[
                ('policy_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('trace_retention_days', models.IntegerField(default=30, help_text='How long to keep trace events (default: 30 days for free tier)')),
                ('snapshot_retention_days', models.IntegerField(default=90, help_text='How long to keep environment snapshots')),
                ('audit_log_retention_days', models.IntegerField(default=365, help_text='How long to keep audit logs (compliance requirement)')),
                ('cached_response_retention_days', models.IntegerField(default=7, help_text='How long to keep cached LLM/tool responses')),
                ('wal_retention_days', models.IntegerField(default=7, help_text='How long to keep WAL entries after completion')),
                ('auto_redact_pii', models.BooleanField(default=True, help_text='Automatically redact PII before storage')),
                ('pii_redaction_mode', models.CharField(choices=[('mask', 'Mask PII (keep format, hide content)'), ('hash', 'Hash PII (one-way, for deduplication)'), ('remove', 'Remove PII entirely'), ('none', 'No redaction (requires consent)')], default='mask', max_length=50)),
                ('tier', models.CharField(choices=[('free', 'Free (30 days)'), ('paid', 'Paid (90 days)'), ('enterprise', 'Enterprise (custom)')], default='free', max_length=50)),
                ('require_consent_for_raw_traces', models.BooleanField(default=True, help_text='Require explicit consent to store unredacted traces')),
                ('auto_cleanup_enabled', models.BooleanField(default=True, help_text='Automatically delete expired data')),
                ('last_cleanup_at', models.DateTimeField(blank=True, help_text='Last time cleanup ran', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('custom_rules', models.JSONField(default=dict, help_text='Custom retention rules for specific data types')),
                ('organization', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='retention_policy_settings', to='api.organization')),
            ],
            options={
                'db_table': 'retention_policies',
            },
        ),
        migrations.CreateModel(
            name='DataConsentRecord',
            fields=[
                ('consent_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('consent_type', models.CharField(choices=[('raw_trace_storage', 'Store unredacted traces'), ('llm_response_caching', 'Cache LLM responses'), ('extended_retention', 'Extend retention period'), ('analytics', 'Use data for analytics'), ('model_training', 'Use data for model training')], help_text='Type of consent granted', max_length=100)),
                ('applies_to_all_runs', models.BooleanField(default=False, help_text='Applies to all runs for this organization')),
                ('is_granted', models.BooleanField(default=True)),
                ('granted_at', models.DateTimeField(auto_now_add=True)),
                ('revoked_at', models.DateTimeField(blank=True, null=True)),
                ('expires_at', models.DateTimeField(blank=True, help_text='When consent expires', null=True)),
                ('granted_by', models.CharField(help_text='Who granted consent (user ID, email, etc.)', max_length=255)),
                ('notes', models.TextField(blank=True)),
                ('metadata', models.JSONField(default=dict)),
                ('applies_to_runs', models.ManyToManyField(blank=True, help_text='Specific runs this consent applies to', related_name='consent_records', to='api.run')),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='consent_records', to='api.organization')),
            ],
            options={
                'db_table': 'data_consent_records',
                'indexes': [models.Index(fields=['organization', 'consent_type'], name='data_consen_organiz_fba089_idx'), models.Index(fields=['is_granted'], name='data_consen_is_gran_c25753_idx'), models.Index(fields=['expires_at'], name='data_consen_expires_da51fc_idx')],
            },
        ),
        migrations.CreateModel(
            name='DataDeletionRequest',
            fields=[
                ('request_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('request_type', models.CharField(choices=[('full_org', 'Delete all organization data'), ('specific_runs', 'Delete specific runs'), ('time_range', 'Delete data in time range'), ('pii_only', 'Delete only PII data')], max_length=50)),
                ('delete_after_date', models.DateTimeField(blank=True, help_text='Delete data created after this date', null=True)),
                ('delete_before_date', models.DateTimeField(blank=True, help_text='Delete data created before this date', null=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('failed', 'Failed'), ('cancelled', 'Cancelled')], default='pending', max_length=50)),
                ('requested_at', models.DateTimeField(auto_now_add=True)),
                ('requested_by', models.CharField(max_length=255)),
                ('scheduled_for', models.DateTimeField(help_text='When deletion should occur')),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('items_deleted', models.JSONField(default=dict, help_text='Count of deleted items by type')),
                ('legal_basis', models.CharField(choices=[('gdpr_right_to_erasure', 'GDPR Right to Erasure'), ('ccpa_right_to_delete', 'CCPA Right to Delete'), ('retention_policy', 'Retention Policy Expiration'), ('consent_revocation', 'Consent Revocation'), ('user_request', 'User Request'), ('admin_request', 'Admin Request')], max_length=100)),
                ('notes', models.TextField(blank=True)),
                ('deletion_certificate', models.JSONField(default=dict, help_text='Cryptographic proof of deletion')),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='deletion_requests', to='api.organization')),
                ('runs_to_delete', models.ManyToManyField(blank=True, related_name='deletion_requests', to='api.run')),
            ],
            options={
                'db_table': 'data_deletion_requests',
                'indexes': [models.Index(fields=['organization', 'status'], name='data_deleti_organiz_db6f9b_idx'), models.Index(fields=['scheduled_for'], name='data_deleti_schedul_47d80a_idx'), models.Index(fields=['requested_at'], name='data_deleti_request_1675bc_idx')],
            },
        ),
        migrations.CreateModel(
            name='PrivacyAuditLog',
            fields=[
                ('audit_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('action_type', models.CharField(choices=[('data_access', 'Data Access'), ('data_export', 'Data Export'), ('data_deletion', 'Data Deletion'), ('consent_granted', 'Consent Granted'), ('consent_revoked', 'Consent Revoked'), ('retention_policy_change', 'Retention Policy Change'), ('pii_redaction', 'PII Redaction'), ('key_rotation', 'API Key Rotation'), ('policy_update', 'Policy Update')], max_length=100)),
                ('performed_by', models.CharField(help_text='User ID or system process', max_length=255)),
                ('performed_at', models.DateTimeField(auto_now_add=True)),
                ('details', models.JSONField(default=dict, help_text='Action details (what changed, why, etc.)')),
                ('is_gdpr_related', models.BooleanField(default=False, help_text='Related to GDPR request')),
                ('is_ccpa_related', models.BooleanField(default=False, help_text='Related to CCPA request')),
                ('success', models.BooleanField(default=True)),
                ('error_message', models.TextField(blank=True)),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('user_agent', models.TextField(blank=True)),
                ('affected_runs', models.ManyToManyField(blank=True, related_name='privacy_audits', to='api.run')),
                ('organization', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='privacy_audit_logs', to='api.organization')),
            ],
            options={
                'db_table': 'privacy_audit_logs',
                'indexes': [models.Index(fields=['organization', 'action_type'], name='privacy_aud_organiz_7bfef1_idx'), models.Index(fields=['performed_at'], name='privacy_aud_perform_4a45c2_idx'), models.Index(fields=['is_gdpr_related'], name='privacy_aud_is_gdpr_bf2bc9_idx'), models.Index(fields=['is_ccpa_related'], name='privacy_aud_is_ccpa_d11fdb_idx')],
            },
        ),
        migrations.CreateModel(
            name='RedactionLog',
            fields=[
                ('log_id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('redaction_type', models.CharField(choices=[('pii_mask', 'PII masked'), ('pii_hash', 'PII hashed'), ('pii_remove', 'PII removed'), ('full_redact', 'Entire field redacted'), ('consent_revoke', 'Redacted due to consent revocation')], max_length=50)),
                ('fields_redacted', models.JSONField(default=list, help_text='List of fields that were redacted')),
                ('pii_types_found', models.JSONField(default=list, help_text='Types of PII found (SSN, email, etc.)')),
                ('redacted_at', models.DateTimeField(auto_now_add=True)),
                ('redacted_by', models.CharField(help_text='System, user ID, or automated process', max_length=255)),
                ('reason', models.TextField(help_text='Why redaction was performed')),
                ('is_reversible', models.BooleanField(default=False, help_text='Can this redaction be reversed (e.g., via hash lookup)')),
                ('hash_salt', models.CharField(blank=True, help_text='Salt used for hashing (for reversal)', max_length=255, null=True)),
                ('run', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='redaction_logs', to='api.run')),
                ('trace_event', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='redaction_logs', to='api.traceevent')),
            ],
            options={
                'db_table': 'redaction_logs',
                'indexes': [models.Index(fields=['run'], name='redaction_l_run_id_93e8d4_idx'), models.Index(fields=['trace_event'], name='redaction_l_trace_e_ce91db_idx'), models.Index(fields=['redacted_at'], name='redaction_l_redacte_9de46c_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='replaysnapshot',
            index=models.Index(fields=['run'], name='replay_snap_run_id_10d65e_idx'),
        ),
        migrations.AddIndex(
            model_name='replaysnapshot',
            index=models.Index(fields=['is_replayable'], name='replay_snap_is_repl_7284e4_idx'),
        ),
        migrations.AddIndex(
            model_name='replaysnapshot',
            index=models.Index(fields=['created_at'], name='replay_snap_created_ea6eee_idx'),
        ),
        migrations.AddIndex(
            model_name='replayrun',
            index=models.Index(fields=['original_run'], name='replay_runs_origina_f892c6_idx'),
        ),
        migrations.AddIndex(
            model_name='replayrun',
            index=models.Index(fields=['status'], name='replay_runs_status_7abddc_idx'),
        ),
        migrations.AddIndex(
            model_name='replayrun',
            index=models.Index(fields=['started_at'], name='replay_runs_started_5b8fe5_idx'),
        ),
        migrations.AddIndex(
            model_name='cachedtoolresponse',
            index=models.Index(fields=['snapshot', 'seq_no'], name='cached_tool_snapsho_818dc7_idx'),
        ),
        migrations.AddIndex(
            model_name='cachedtoolresponse',
            index=models.Index(fields=['params_hash'], name='cached_tool_params__e2ba3f_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='cachedtoolresponse',
            unique_together={('snapshot', 'seq_no')},
        ),
        migrations.AddIndex(
            model_name='cachedllmresponse',
            index=models.Index(fields=['snapshot', 'seq_no'], name='cached_llm__snapsho_a891fa_idx'),
        ),
        migrations.AddIndex(
            model_name='cachedllmresponse',
            index=models.Index(fields=['prompt_hash'], name='cached_llm__prompt__7bc9a4_idx'),
        ),
        migrations.AddIndex(
            model_name='cachedllmresponse',
            index=models.Index(fields=['expires_at'], name='cached_llm__expires_e4504e_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='cachedllmresponse',
            unique_together={('snapshot', 'seq_no')},
        ),
        migrations.AddIndex(
            model_name='retentionpolicy',
            index=models.Index(fields=['organization'], name='retention_p_organiz_30ea2d_idx'),
        ),
        migrations.AddIndex(
            model_name='retentionpolicy',
            index=models.Index(fields=['tier'], name='retention_p_tier_6f1cd8_idx'),
        ),
    ]
